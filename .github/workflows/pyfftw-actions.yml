name: Check pyFFTW
on:
  workflow_dispatch:
  schedule:
    - cron: '0 14 * * *'  # 2pm UTC == 9am EST
jobs:
  check_pyfftw:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
  
    steps:
      - name: Checkout STUMPY
        uses: actions/checkout@v4
        with:
          repository: stumpy-dev/stumpy

      - name: Get Required Python Version
        id: python
        run: |
          python -m pip install pandas packaging lxml
          echo "version=$(python ./versions.py -pkg pyfftw)" >> $GITHUB_OUTPUT
        shell: bash

      # Checkout python version
      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: "${{ steps.python.outputs.version }}"

      - name: Display Python Version
        run: python -c "import sys; print(sys.version)"
        shell: bash

      - name: Set Up Pixi
        uses: prefix-dev/setup-pixi@v0.9.4
        with:
          pixi-version: v0.62.2

      - name: Set Up Python
        run: pixi add python="${{ steps.python.outputs.version }}"
        shell: bash

      - name: Install Conda-Forge STUMPY from source
        run: pixi add stumpy 
        
      - name: Install FFTW and pyFFTW
        run: pixi add fftw pyfftw
        shell: bash

      - name: Display Python Version
        run: pixi run python -c "import sys; print(sys.version)"
        shell: bash

      - name: Show Full Numba Environment
        run: pixi run python -m numba -s
        shell: bash

      - name: Show installed packages fftw and pyfftw
        run: pixi list | grep -E 'fftw|pyfftw'
        shell: bash

      - name: Run Unit Tests
        run: pixi run bash ./test.sh unit
        shell: bash
